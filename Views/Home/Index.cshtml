@{
    ViewData["Title"] = "Home Page";
}
<div>
    <button type="button" class="command" id="startButton" onclick="start()" disabled>Start</button>
    <button type="button" class="command" id="stopButton" onclick="stop()" disabled>Stop</button>
</div>

<img id="targetImage" src="/images/info.png" width="200" height="200" style="border: 1px solid black" />
<style>
    .command[disabled] {
        opacity: 0.3;
        filter: saturate(40%);
        cursor: not-allowed;
    }
    .command:not([disabled]):hover {
        filter: brightness(140%);
    }
    .command {
        cursor: pointer;
        width: 88px;
        border: none;
        border-radius: 5px;
        color: white;
        margin: 0 20px 20px 0;
        padding: 5px 0;
        box-sizing: border-box;
    }
    #startButton {
        background-color: green;
    }
    #stopButton {
        background-color: #c32222;
    }
</style>

@section Scripts
{
<script src="https://cdn.jsdelivr.net/npm/@@aspnet/signalr@1.1.4/dist/browser/signalr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/msgpack5@4.2.1/dist/msgpack5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@@aspnet/signalr-protocol-msgpack@1.1.0/dist/browser/signalr-protocol-msgpack.min.js"></script>
<script>
let connection = new signalR.HubConnectionBuilder()
    .withUrl("/image-stream")
    .withHubProtocol(new signalR.protocols.msgpack.MessagePackHubProtocol())
    .build();

connection.on('NotifyStatusChange', newStatus => {
    console.log("Lo stato è cambiato in: ", newStatus);

    const isStarted = newStatus == 'started';
    document.getElementById('startButton').disabled = isStarted;
    document.getElementById('stopButton').disabled = !isStarted;
});

let previousObjectURL;
connection.on('ReceiveImage', data => {
    //Creo un blob a partire dai dati binari che ho ricevuto
    //La variabile data è di tipo Uint8Array
    const blob = new Blob([data], {type: "image/png"});
    
    //Creo un URL per il blob, così che si possa assegnare alla proprietà src di un elemento IMG
    const currentObjectURL = URL.createObjectURL(blob);
    document.getElementById('targetImage').src = currentObjectURL;

    //Dealloco l'URL generato precedentemente, così da evitare dei memory leak.
    if (previousObjectURL) {
        URL.revokeObjectURL(previousObjectURL);
    }

    //Conservo il riferimento all'URL che ho generato poco fa, così che lo si possa deallocare poi
    previousObjectURL = currentObjectURL;
});
 
connection.start();

function start() {
    connection.invoke("Start").catch(err => alert("Non è stato possibile fare Start. Motivo: " + err.toString()));
}

function stop() {
    connection.invoke("Stop").catch(err => alert("Non è stato possibile fare Stop. Motivo: " + err.toString()));
}
</script>
}